<!doctype html>
<html>
    <head>
        <title>My PouchApp</title>
        <script src="cordova-2.1.0.js" type="text/javascript">
        </script>
        <script type = "text/javascript" src="IndexedDBShim.min.js">
        </script>
        <script type = "text/javascript" src="pouch.alpha.js">
        </script>
        <meta charset="UTF-8">
    </head>
    <body>
    	<h1>Preparing Quantum Phasers...</h1>
        <script type = "text/javascript">
            var pouchdb, running = false;
            var syncUrl = 'http://ether.local:5984/myapp';

			function kickOff(doc) {
				if (running) {
					console.log("running", running)
					console.log("latest", doc._rev)
					if (running != doc._rev) {location && location.reload()}
					return;
				}
				window.ddoc = doc;
				$('head').append("<style>"+doc["css"]+"</style>");
				eval(doc["js"])
				running = doc._rev || true;
			};

            setTimeout(function() {
            	Pouch('idb://myapp', function(err, db){
            		if (err) {
            			console.error(err);
            		}
            		else {
            			pouchdb = db;
            			console.log("Pouch ready");
            			$("body").append("<h2>Pouch ready</h2>")
        				pouchdb.allDocs({include_docs : true}, function(err, docs) {
        					console.log("all", docs);
        					docs.rows.forEach(function(row) {
        						if (row.id == "myapp") {
	 								kickOff(row.doc);
        						}
        					})
        				})
            			Pouch.replicate(syncUrl, 'idb://myapp',
            			function(err) {
            				pouchdb.allDocs({include_docs : true}, function(err, docs) {
            					console.log("all", docs);
            					docs.rows.forEach(function(row) {
            						if (row.id == "myapp") {
		 								kickOff(row.doc);
            						}
            					})
            				})
            			})
            		}
            	});
            }, 1000); // wait for idb to open
        </script>
    </body>
</html>
